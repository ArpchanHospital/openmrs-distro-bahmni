<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <parent>
        <artifactId>bahmni</artifactId>
        <groupId>org.openmrs.distro</groupId>
        <version>4.0-SNAPSHOT</version>
    </parent>
    <modelVersion>4.0.0</modelVersion>

    <artifactId>distro</artifactId>
    <name>Bahmni Distribution</name>
    <description>Scripts for building the Bahmni distribution</description>

    <properties>
        <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
        <openMRSVersion>1.9.8-SNAPSHOT</openMRSVersion>
        <bahmniCoreVersion>4.0-SNAPSHOT</bahmniCoreVersion>
        <appframeworkModuleVersion>2.1</appframeworkModuleVersion>
        <uiframeworkModuleVersion>3.2</uiframeworkModuleVersion>
        <idgenModuleVersion>2.8-SNAPSHOT</idgenModuleVersion>
        <idgenWebServicesModuleVersion>1.0-SNAPSHOT</idgenWebServicesModuleVersion>
        <uicommonsModuleVersion>1.0</uicommonsModuleVersion>
        <emrapiModuleVersion>1.2-SNAPSHOT</emrapiModuleVersion>
        <providerManagementVersion>2.1</providerManagementVersion>
        <reportingVersion>0.9.1-SNAPSHOT</reportingVersion>
        <metadataSharingVersion>1.1.8</metadataSharingVersion>
        <uilibraryVersion>1.5</uilibraryVersion>
        <htmlwidgetsVersion>1.6.4</htmlwidgetsVersion>
        <calculationVersion>1.1</calculationVersion>
        <metadataMappingVersion>1.0.1</metadataMappingVersion>    
        <serializationVersion>0.2.8-SNAPSHOT</serializationVersion>
        <eventModuleVersion>2.2-SNAPSHOT</eventModuleVersion>
        <addressHierarchyVersion>2.4-SNAPSHOT</addressHierarchyVersion>
        <webServicesRestVersion>2.5-SNAPSHOT</webServicesRestVersion>
        <bahmniRegistrationVersion>4.0-SNAPSHOT</bahmniRegistrationVersion>
        <bahmniOpdVersion>4.0-SNAPSHOT</bahmniOpdVersion>
        <bahmniAppsVersion>4.0-SNAPSHOT</bahmniAppsVersion>
        <atomfeedModuleVersion>2.0-SNAPSHOT</atomfeedModuleVersion>
        <bedManagementVersion>4.0-SNAPSHOT</bedManagementVersion>
        <mailappenderVersion>4.0-SNAPSHOT</mailappenderVersion>
    </properties>

    <dependencies>

        <!-- Main OpenMRS web app -->
        <dependency>
            <groupId>org.openmrs.web</groupId>
            <artifactId>openmrs-webapp</artifactId>
            <version>${openMRSVersion}</version>
            <type>war</type>
        </dependency>

        <!-- Modules actively developed in Bahmni -->
        <dependency>
            <groupId>org.bahmni.module</groupId>
            <artifactId>bahmnicore-omod</artifactId>
            <version>${bahmniCoreVersion}</version>
        </dependency>
        <dependency>
            <groupId>org.bahmni.module</groupId>
            <artifactId>elisatomfeedclient-omod</artifactId>
            <version>${bahmniCoreVersion}</version>
        </dependency>
        <dependency>
            <groupId>org.bahmni.module</groupId>
            <artifactId>openerp-atomfeed-client-omod</artifactId>
            <version>${bahmniCoreVersion}</version>
        </dependency>
        <!-- end -->

        <dependency>
            <groupId>org.openmrs.module</groupId>
            <artifactId>bedmanagement-omod</artifactId>
            <version>${bedManagementVersion}</version>
        </dependency>

        <!-- Modules developed and maintained in OpenMRS -->
        <dependency>
            <groupId>org.openmrs.module</groupId>
            <artifactId>appframework-omod</artifactId>
            <version>${appframeworkModuleVersion}</version>
        </dependency>
        <dependency>
            <groupId>org.openmrs.module</groupId>
            <artifactId>uiframework-omod</artifactId>
            <version>${uiframeworkModuleVersion}</version>
        </dependency>
        <dependency>
            <groupId>org.openmrs.module</groupId>
            <artifactId>uicommons-omod</artifactId>
            <version>${uicommonsModuleVersion}</version>
        </dependency>
         <dependency>
            <groupId>org.openmrs.module</groupId>
            <artifactId>emrapi-omod</artifactId>
            <version>${emrapiModuleVersion}</version>
        </dependency>
        <dependency>
            <groupId>org.openmrs.module</groupId>
            <artifactId>providermanagement-omod</artifactId>
            <version>${providerManagementVersion}</version>
        </dependency>
        <dependency>
            <groupId>org.openmrs.module</groupId>
            <artifactId>reporting-omod</artifactId>
            <version>${reportingVersion}</version>
        </dependency>
        <dependency>
            <groupId>org.openmrs.module</groupId>
            <artifactId>metadatasharing-omod</artifactId>
            <version>${metadataSharingVersion}</version>
        </dependency>
        <dependency>
            <groupId>org.openmrs.module</groupId>
            <artifactId>uilibrary-omod</artifactId>
            <version>${uilibraryVersion}</version>
        </dependency>
        <dependency>
            <groupId>org.openmrs.module</groupId>
            <artifactId>htmlwidgets-omod</artifactId>
            <version>${htmlwidgetsVersion}</version>
        </dependency>
        <dependency>
            <groupId>org.openmrs.module</groupId>
            <artifactId>calculation-omod</artifactId>
            <version>${calculationVersion}</version>
        </dependency>
        <dependency>
            <groupId>org.openmrs.module</groupId>
            <artifactId>metadatamapping-omod</artifactId>
            <version>${metadataMappingVersion}</version>
        </dependency>

        <dependency>
            <groupId>org.openmrs.module</groupId>
            <artifactId>serialization.xstream-omod</artifactId>
            <version>${serializationVersion}</version>
            <type>omod</type>
        </dependency>
        
         <dependency>
            <groupId>org.openmrs</groupId>
            <artifactId>event-omod</artifactId>
            <version>${eventModuleVersion}</version>
        </dependency>
        <!-- end -->

        <!-- Modules forked from OpenMRS and maintained in Bahmni -->
        <dependency>
            <groupId>org.openmrs.module</groupId>
            <artifactId>idgen-omod</artifactId>
            <version>${idgenModuleVersion}</version>
        </dependency>
        <dependency>
            <groupId>org.openmrs.module</groupId>
            <artifactId>idgen-webservices-omod</artifactId>
            <version>${idgenWebServicesModuleVersion}</version>
        </dependency>
        <dependency>
            <groupId>org.openmrs.module</groupId>
            <artifactId>addresshierarchy-omod</artifactId>
            <version>${addressHierarchyVersion}</version>
        </dependency>
        <dependency>
            <groupId>org.openmrs.module</groupId>
            <artifactId>webservices.rest-omod</artifactId>
            <version>${webServicesRestVersion}</version>
        </dependency>
        <dependency>
            <groupId>org.bahmni.module</groupId>
            <artifactId>mail-appender</artifactId>
            <version>${mailappenderVersion}</version>
        </dependency>
        <!-- end -->

        <!-- Modules from other maintainers-->
        <dependency>
          <groupId>org.ict4h.openmrs</groupId>
          <artifactId>openmrs-atomfeed-omod</artifactId>
          <version>${atomfeedModuleVersion}</version>
        </dependency>
        <!-- end -->
    </dependencies>

    <pluginRepositories>
        <pluginRepository>
            <id>central</id>
            <url>http://repo1.maven.org/maven2</url>
            <name>Repository for plugins</name>
        </pluginRepository>
        <pluginRepository>
            <id>openmrs-repo</id>
            <name>OpenMRS Nexus Repository</name>
            <url>http://mavenrepo.openmrs.org/nexus/content/repositories/public</url>
            <snapshots>
                <enabled>false</enabled>
            </snapshots>
        </pluginRepository>
    </pluginRepositories>    

    <profiles>
        <profile>
            <id>openmrs-release</id>
            <!-- Bahmni Front End modules bundled as OpenMRS omods -->
            <dependencies>
                <dependency>
                    <groupId>org.openmrs.module</groupId>
                    <artifactId>bahmni.registration-omod</artifactId>
                    <version>${bahmniRegistrationVersion}</version>
                </dependency>
                <dependency>
                    <groupId>org.openmrs.module</groupId>
                    <artifactId>bahmni.opd-omod</artifactId>
                    <version>${bahmniOpdVersion}</version>
                </dependency>
                <dependency>
                    <groupId>org.openmrs.module</groupId>
                    <artifactId>bahmni.apps-omod</artifactId>
                    <version>${bahmniAppsVersion}</version>
                </dependency>
            </dependencies>
            <!-- end -->
        </profile>
    </profiles>

    <build>
        <pluginManagement>
            <plugins>
                <plugin>
                    <groupId>org.apache.maven.plugins</groupId>
                    <artifactId>maven-compiler-plugin</artifactId>
                    <configuration>
                        <target>1.6</target>
                        <source>1.6</source>
                    </configuration>
                </plugin>
                <plugin>
                    <groupId>org.apache.maven.plugins</groupId>
                    <artifactId>maven-dependency-plugin</artifactId>
                    <version>2.4</version>
                </plugin>
            </plugins>
        </pluginManagement>

        <plugins>
            <!--
            Copy all of the modules we depend on (this also gets extra jars we don't need).
            We'll end up with things like "reporting-omod-0.7.2.1.jar".
            -->
            <plugin>
                <groupId>org.apache.maven.plugins</groupId>
                <artifactId>maven-dependency-plugin</artifactId>
                <version>2.8</version>
                <executions>
                    <execution>
                        <id>copy-dependencies</id>
                        <phase>package</phase>
                        <goals>
                            <goal>copy-dependencies</goal>
                        </goals>
                        <configuration>
                            <excludeTransitive>true</excludeTransitive>
                            <useBaseVersion>true</useBaseVersion>
                            <outputDirectory>${project.build.directory}/dependencies</outputDirectory>
                        </configuration>
                    </execution>
                </executions>
            </plugin>

            <!--
            Rename things like "reporting-omod-0.7.2.1.jar" to "reporting-0.7.2.1.omod".
            It also copies other jars that are not omods
            -->
            <plugin>
                <artifactId>maven-antrun-plugin</artifactId>
                <version>1.7</version>
                <executions>
                    <execution>
                        <id>rename-jars-to-omod</id>
                        <phase>package</phase>
                        <configuration>
                            <target>
                                <move todir="${project.build.directory}/distro">
                                    <fileset dir="${project.build.directory}/dependencies" />
                                    <mapper type="regexp" from="^(.+)-omod-(.+)\.jar" to="\1-\2.omod" />
                                </move>
                            </target>
                        </configuration>
                        <goals>
                            <goal>run</goal>
                        </goals>
                    </execution>

                     <execution>
                        <id>copy-other-jars</id>
                        <phase>package</phase>
                        <configuration>
                            <target>
                                <move todir="${project.build.directory}/distro">
                                    <fileset dir="${project.build.directory}/dependencies">
                                        <include name="*.jar"/>
                                    </fileset>
                                </move>
                            </target>
                        </configuration>
                        <goals>
                            <goal>run</goal>
                        </goals>
                    </execution>

                    <execution>
                        <id>move-war-to-dist</id>
                        <phase>package</phase>
                        <configuration>
                            <target>
                                <move todir="${project.build.directory}/distro">
                                    <fileset dir="${project.build.directory}/dependencies">
                                        <include name="*.war"/>
                                    </fileset>
                                </move>
                            </target>
                        </configuration>
                        <goals>
                            <goal>run</goal>
                        </goals>
                    </execution>

                    <!-- For some reason the serialization.xstream-omod artifact is .omod, not .jar -->
                    <execution>
                        <id>rename-omods-to-omod</id>
                        <phase>package</phase>
                        <configuration>
                            <target>
                                <move todir="${project.build.directory}/distro">
                                    <fileset dir="${project.build.directory}/dependencies" />
                                    <mapper type="regexp" from="^(.+)-omod-(.+)\.omod" to="\1-\2.omod" />
                                </move>
                            </target>
                        </configuration>
                        <goals>
                            <goal>run</goal>
                        </goals>
                    </execution>
                </executions>
            </plugin>

            <!--
            Assemble all of these omods into a zip file
            -->
            <plugin>
                <artifactId>maven-assembly-plugin</artifactId>
                <version>2.3</version>
                <configuration>
                    <descriptors>
                        <descriptor>${basedir}/src/main/assembly/assembly.xml</descriptor>
                    </descriptors>
                </configuration>
                <executions>
                    <execution>
                        <id>make-assembly</id>
                        <phase>package</phase>
                        <goals>
                            <goal>single</goal>
                        </goals>
                    </execution>
                </executions>
            </plugin>
        </plugins>
    </build>

</project>
